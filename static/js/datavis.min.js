"use strict";var months=["january","february","march","april","may","june","july","august","september","october","november","december"];var select={year:{input:document.getElementById("select-year"),addOptions:function addOptions(e){e.forEach(function(e){select.year.input.appendChild(select.createOption(e))});select.year.input.appendChild(select.createOption("all"));select.year.input.selectedIndex=e.length;select.year.input.addEventListener("change",function(){graph.update()})}},createOption:function createOption(e){var t=document.createElement("option");t.value=e;var n=document.createTextNode(e);t.appendChild(n);return t}};var data={get:function get(){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){e(JSON.parse(n.responseText))}else if(n.status===404){t(new Error("The server responded with 404, not found"))}};n.open("GET","/data",true);n.send()})},request:function request(a){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){e(JSON.parse(n.responseText))}else if(n.status===404){t(new Error("The server responded with 404, not found"))}};n.open("GET",a,true);n.send()})},parse:{usage:function usage(e,a){var r=[];e.forEach(function(t,e){var n=false;if(e===0){r.push({name:t[a],count:1});return}r.forEach(function(e){if(e.name===t[a]){e.count++;n=true}});if(n===false){r.push({name:t[a],count:1})}});if(a==="sailSize"){r.sort(function(e,t){return e.name-t.name})}else{r.sort(function(e,t){return t.count-e.count})}return r},session:function session(e){var h=[];e.forEach(function(e,t){var n=parseInt(e.date.split("-")[1]);var a=parseInt(e.date.split("-")[2]);var r="".concat(months[n-1]," ").concat(a);var s=false;if(t===0){h.push({name:r,count:1,month:n});return}h.forEach(function(e){if(e.name===r){e.count++;s=true}});if(!s){var o=h[h.length-1].month;if(o+1===13){h.push({name:r,count:1,month:n})}else if(o+1!==n){var i=n-o-1;if(i<0){var c=12-o;var u=n-1;for(var d=0;d<c;d++){h.push({name:months[o+d]?"".concat(months[o+d]," ").concat(a-1):"".concat(months[11]," ").concat(a-1),count:0,month:o+(1+d)===13?1:o+(1+d)})}for(var l=0;l<u;l++){h.push({name:"".concat(months[l]," ").concat(a),count:0,month:l+1})}h.push({name:r,count:1,month:n})}else{for(var p=i;p>0;p--){h.push({name:months[n-(1+p)]?"".concat(months[n-(1+p)]," ").concat(a):"".concat(months[11]," ").concat(a-1),count:0,month:n-(1+p)===0?12:n-(1+p)})}h.push({name:r,count:1,month:n})}}else{h.push({name:r,count:1,month:n})}}});return h}}};var graph={load:function load(){data.get().then(function(e){var a=[];document.getElementById("total-sessions").textContent=e.length;e.sort(function(e,t){var n=e.date.split("-").reverse();var a=t.date.split("-").reverse();return new Date(n)-new Date(a)});e.forEach(function(e,t){var n=e.date.split("-")[2];if(t===0){a.push(n)}else if(a[a.length-1]!==n){a.push(n)}});select.year.addOptions(a);return{sessions:data.parse.session(e),sail:data.parse.usage(e,"sailSize"),board:data.parse.usage(e,"board"),spots:data.parse.usage(e,"spot")}}).then(function(e){if(e.sessions.length<=0){var t=document.getElementsByClassName("content")[0];while(t.firstChild){t.removeChild(t.firstChild)}var n=document.createElement("h2");var a=document.createTextNode("You don't have any statistics yet. Go out and shred!");n.style="margin-bottom: 2rem;";n.appendChild(a);var r=document.createElement("a");r.href="/add-session";r.classList.add("button");var s=document.createTextNode("Add session");r.appendChild(s);t.appendChild(n);t.appendChild(r)}else{graph.render(e.sessions,"session-amount");graph.render(e.sail,"sail-usage");graph.render(e.board,"board-usage");graph.render(e.spots,"spot-visits")}}).catch(function(e){return console.error(e)})},update:function update(){data.get().then(function(e){var t=select.year.input.value;e.sort(function(e,t){var n=e.date.split("-").reverse();var a=t.date.split("-").reverse();return new Date(n)-new Date(a)});if(t!=="all")e=e.filter(function(e){return e.date.split("-")[2]===t});document.getElementById("total-sessions").textContent=e.length;return{sessions:data.parse.session(e),sail:data.parse.usage(e,"sailSize"),board:data.parse.usage(e,"board"),spots:data.parse.usage(e,"spot")}}).then(function(e){graph.render(e.sessions,"session-amount");graph.render(e.sail,"sail-usage");graph.render(e.board,"board-usage");graph.render(e.spots,"spot-visits")}).catch(function(e){return console.error(e)})},render:function render(t,e){var n={width:document.getElementById(e).clientWidth,height:500};var a={top:10,right:0,bottom:30,left:30};var r=d3.scaleBand().domain(t.map(function(e){return e.name})).range([a.left,n.width-a.right]).padding(.1);var s=d3.scaleLinear().domain([0,d3.max(t,function(e){return e.count})]).nice().range([n.height-a.bottom,a.top]);var o=function xAxis(e){return e.attr("transform","translate(0,".concat(n.height-a.bottom,")")).call(d3.axisBottom(r).tickSizeOuter(0))};var i=function yAxis(e){return e.attr("transform","translate(".concat(a.left,",0)")).call(d3.axisLeft(s)).call(function(e){return e.select(".domain").remove()}).call(d3.axisLeft(s).ticks(d3.max(t,function(e){return e.count})))};var c=d3.select("#".concat(e)).attr("width",n.width).attr("height",n.height);c.selectAll("g").remove();c.append("g").attr("fill","steelblue").selectAll("rect").data(t).enter().append("rect").attr("x",function(e){return r(e.name)}).attr("y",function(e){return s(e.count)}).attr("height",function(e){return s(0)-s(e.count)}).attr("width",r.bandwidth());c.append("g").call(o);c.append("g").call(i)}};graph.load();
