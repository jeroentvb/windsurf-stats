"use strict";function checkLocalstorage(){var t="test";try{localStorage.setItem(t,t);localStorage.removeItem(t);return true}catch(t){return false}}var localstorage=checkLocalstorage();var months=["january","february","march","april","may","june","july","august","september","october","november","december"];var select={year:{input:document.getElementById("select-year"),addOptions:function addOptions(t){t.forEach(function(t){select.year.input.appendChild(select.createOption(t))});select.year.input.appendChild(select.createOption("all"));select.year.input.selectedIndex=t.length;select.year.input.addEventListener("change",function(){graph.update()})}},createOption:function createOption(t){var e=document.createElement("option");e.value=t;var n=document.createTextNode(t);e.appendChild(n);return e}};var data={get:function get(){return new Promise(function(e,n){if(localstorage&&localStorage.getItem("sessionData")){var t=JSON.parse(localStorage.getItem("sessionData"));e(t)}else{data.request("/data").then(function(t){if(localStorage)localStorage.setItem("sessionData",JSON.stringify(t));e(t)}).catch(function(t){return n(t)})}})},request:function request(a){return new Promise(function(t,e){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){t(JSON.parse(n.responseText))}else if(n.status===404){e(new Error("The server responded with 404, not found"))}};n.open("GET",a,true);n.send()})},parse:{usage:function usage(t,a){var r=[];t.forEach(function(e,t){var n=false;if(t===0){r.push({name:e[a],count:1});return}r.forEach(function(t){if(t.name===e[a]){t.count++;n=true}});if(n===false){r.push({name:e[a],count:1})}});if(a==="sailSize"){r.sort(function(t,e){return t.name-e.name})}else{r.sort(function(t,e){return e.count-t.count})}return r},session:function session(t){var h=[];t.forEach(function(t,e){var n=parseInt(t.date.split("-")[1]);var a=parseInt(t.date.split("-")[2]);var r="".concat(months[n-1]," ").concat(a);var o=false;if(e===0){h.push({name:r,count:1,month:n});return}h.forEach(function(t){if(t.name===r){t.count++;o=true}});if(!o){var s=h[h.length-1].month;if(s+1===13){h.push({name:r,count:1,month:n})}else if(s+1!==n){var c=n-s-1;if(c<0){var i=12-s;var u=n-1;for(var l=0;l<i;l++){h.push({name:months[s+l]?"".concat(months[s+l]," ").concat(a-1):"".concat(months[11]," ").concat(a-1),count:0,month:s+(1+l)===13?1:s+(1+l)})}for(var d=0;d<u;d++){h.push({name:"".concat(months[d]," ").concat(a),count:0,month:d+1})}h.push({name:r,count:1,month:n})}else{for(var p=c;p>0;p--){h.push({name:months[n-(1+p)]?"".concat(months[n-(1+p)]," ").concat(a):"".concat(months[11]," ").concat(a-1),count:0,month:n-(1+p)===0?12:n-(1+p)})}h.push({name:r,count:1,month:n})}}else{h.push({name:r,count:1,month:n})}}});return h}}};var graph={load:function load(){data.get().then(function(t){var a=[];document.getElementById("total-sessions").textContent=t.length;t.sort(function(t,e){var n=t.date.split("-").reverse();var a=e.date.split("-").reverse();return new Date(n)-new Date(a)});t.forEach(function(t,e){var n=t.date.split("-")[2];if(e===0){a.push(n)}else if(a[a.length-1]!==n){a.push(n)}});select.year.addOptions(a);return{sessions:data.parse.session(t),sail:data.parse.usage(t,"sailSize"),board:data.parse.usage(t,"board"),spots:data.parse.usage(t,"spot")}}).then(function(t){graph.render(t.sessions,"session-amount");graph.render(t.sail,"sail-usage");graph.render(t.board,"board-usage");graph.render(t.spots,"spot-visits")}).catch(function(t){return console.error(t)})},update:function update(){data.get().then(function(t){var e=select.year.input.value;t.sort(function(t,e){var n=t.date.split("-").reverse();var a=e.date.split("-").reverse();return new Date(n)-new Date(a)});if(e!=="all")t=t.filter(function(t){return t.date.split("-")[2]===e});document.getElementById("total-sessions").textContent=t.length;return{sessions:data.parse.session(t),sail:data.parse.usage(t,"sailSize"),board:data.parse.usage(t,"board"),spots:data.parse.usage(t,"spot")}}).then(function(t){graph.render(t.sessions,"session-amount");graph.render(t.sail,"sail-usage");graph.render(t.board,"board-usage");graph.render(t.spots,"spot-visits")}).catch(function(t){return console.error(t)})},render:function render(e,t){var n={width:document.getElementById(t).clientWidth,height:500};var a={top:10,right:0,bottom:30,left:30};var r=d3.scaleBand().domain(e.map(function(t){return t.name})).range([a.left,n.width-a.right]).padding(.1);var o=d3.scaleLinear().domain([0,d3.max(e,function(t){return t.count})]).nice().range([n.height-a.bottom,a.top]);var s=function xAxis(t){return t.attr("transform","translate(0,".concat(n.height-a.bottom,")")).call(d3.axisBottom(r).tickSizeOuter(0))};var c=function yAxis(t){return t.attr("transform","translate(".concat(a.left,",0)")).call(d3.axisLeft(o)).call(function(t){return t.select(".domain").remove()}).call(d3.axisLeft(o).ticks(d3.max(e,function(t){return t.count})))};var i=d3.select("#".concat(t)).attr("width",n.width).attr("height",n.height);i.selectAll("g").remove();i.append("g").attr("fill","steelblue").selectAll("rect").data(e).enter().append("rect").attr("x",function(t){return r(t.name)}).attr("y",function(t){return o(t.count)}).attr("height",function(t){return o(0)-o(t.count)}).attr("width",r.bandwidth());i.append("g").call(s);i.append("g").call(c)}};graph.load();
