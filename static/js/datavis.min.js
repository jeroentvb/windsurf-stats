"use strict";function checkLocalstorage(){var e="test";try{localStorage.setItem(e,e);localStorage.removeItem(e);return!0}catch(e){return!1}}var localstorage=checkLocalstorage();var months=["january","february","march","april","may","june","july","august","september","october","november","december"];var select={year:{input:document.getElementById("select-year"),addOptions:function addOptions(e){e.forEach(function(e){select.year.input.appendChild(select.createOption(e))});select.year.input.appendChild(select.createOption("all"));select.year.input.selectedIndex=e.length;select.year.input.addEventListener("change",function(){graph.update()})}},createOption:function createOption(e){var t=document.createElement("option");t.value=e;var n=document.createTextNode(e);t.appendChild(n);return t}};var data={get:function get(){return new Promise(function(t,n){if(localstorage&&localStorage.getItem("sessionData")){var e=JSON.parse(localStorage.getItem("sessionData"));t(e)}else{data.request("/data").then(function(e){if(localStorage)localStorage.setItem("sessionData",JSON.stringify(e));t(e)}).catch(function(e){return n(e)})}})},request:function request(a){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){e(JSON.parse(n.responseText))}else if(n.status===404){t(new Error("The server responded with 404, not found"))}};n.open("GET",a,!0);n.send()})},parse:{usage:function usage(e,a){var r=[];e.forEach(function(t,e){var n=!1;if(e===0){r.push({name:t[a],count:1});return}r.forEach(function(e){if(e.name===t[a]){e.count++;n=!0}});if(n===!1){r.push({name:t[a],count:1})}});if(a==="sailSize"){r.sort(function(e,t){return e.name-t.name})}else{r.sort(function(e,t){return t.count-e.count})}return r},session:function session(e){var p=[];e.forEach(function(e,t){var n=parseInt(e.date.split("-")[1]);var a=parseInt(e.date.split("-")[2]);var r="".concat(months[n-1]," ").concat(a);var o=!1;if(t===0){p.push({name:r,count:1,month:n});return}p.forEach(function(e){if(e.name===r){e.count++;o=!0}});if(!o){var s=p[p.length-1].month;if(s+1===13){p.push({name:r,count:1,month:n})}else if(s+1!==n){var c=n-s-1;if(c<0){var i=12-s;var u=n-1;for(var d=0;d<i;d++){p.push({name:months[s+d]?"".concat(months[s+d]," ").concat(a-1):"".concat(months[11]," ").concat(a-1),count:0,month:s+(1+d)===13?1:s+(1+d)})}for(var l=0;l<u;l++){p.push({name:"".concat(months[l]," ").concat(a),count:0,month:l+1})}p.push({name:r,count:1,month:n})}else{for(var h=c;h>0;h--){p.push({name:months[n-(1+h)]?"".concat(months[n-(1+h)]," ").concat(a):"".concat(months[11]," ").concat(a-1),count:0,month:n-(1+h)===0?12:n-(1+h)})}p.push({name:r,count:1,month:n})}}else{p.push({name:r,count:1,month:n})}}});return p}}};var graph={load:function load(){data.get().then(function(e){var a=[];document.getElementById("total-sessions").textContent=e.length;e.sort(function(e,t){var n=e.date.split("-").reverse();var a=t.date.split("-").reverse();return new Date(n)-new Date(a)});e.forEach(function(e,t){var n=e.date.split("-")[2];if(t===0){a.push(n)}else if(a[a.length-1]!==n){a.push(n)}});select.year.addOptions(a);return{sessions:data.parse.session(e),sail:data.parse.usage(e,"sailSize"),board:data.parse.usage(e,"board"),spots:data.parse.usage(e,"spot")}}).then(function(e){if(e.sessions.length<=0){var t=document.getElementsByClassName("content")[0];while(t.firstChild){t.removeChild(t.firstChild)}var n=document.createElement("h2");var a=document.createTextNode("You don't have any statistics yet. Go out and shred!");n.style="margin-bottom: 2rem;";n.appendChild(a);var r=document.createElement("a");r.href="/add-session";r.classList.add("button");var o=document.createTextNode("Add session");r.appendChild(o);t.appendChild(n);t.appendChild(r)}else{graph.render(e.sessions,"session-amount");graph.render(e.sail,"sail-usage");graph.render(e.board,"board-usage");graph.render(e.spots,"spot-visits")}}).catch(function(e){return console.error(e)})},update:function update(){data.get().then(function(e){var t=select.year.input.value;e.sort(function(e,t){var n=e.date.split("-").reverse();var a=t.date.split("-").reverse();return new Date(n)-new Date(a)});if(t!=="all")e=e.filter(function(e){return e.date.split("-")[2]===t});document.getElementById("total-sessions").textContent=e.length;return{sessions:data.parse.session(e),sail:data.parse.usage(e,"sailSize"),board:data.parse.usage(e,"board"),spots:data.parse.usage(e,"spot")}}).then(function(e){graph.render(e.sessions,"session-amount");graph.render(e.sail,"sail-usage");graph.render(e.board,"board-usage");graph.render(e.spots,"spot-visits")}).catch(function(e){return console.error(e)})},render:function render(t,e){var n={width:document.getElementById(e).clientWidth,height:500};var a={top:10,right:0,bottom:30,left:30};var r=d3.scaleBand().domain(t.map(function(e){return e.name})).range([a.left,n.width-a.right]).padding(.1);var o=d3.scaleLinear().domain([0,d3.max(t,function(e){return e.count})]).nice().range([n.height-a.bottom,a.top]);var s=function xAxis(e){return e.attr("transform","translate(0,".concat(n.height-a.bottom,")")).call(d3.axisBottom(r).tickSizeOuter(0))};var c=function yAxis(e){return e.attr("transform","translate(".concat(a.left,",0)")).call(d3.axisLeft(o)).call(function(e){return e.select(".domain").remove()}).call(d3.axisLeft(o).ticks(d3.max(t,function(e){return e.count})))};var i=d3.select("#".concat(e)).attr("width",n.width).attr("height",n.height);i.selectAll("g").remove();i.append("g").attr("fill","steelblue").selectAll("rect").data(t).enter().append("rect").attr("x",function(e){return r(e.name)}).attr("y",function(e){return o(e.count)}).attr("height",function(e){return o(0)-o(e.count)}).attr("width",r.bandwidth());i.append("g").call(s);i.append("g").call(c)}};graph.load();
